module.exports=function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseDatabase=void 0;const i=r(n(18));class s{getConnection(){return s.connection||(s.connection=i.default({client:"mysql",connection:{host:process.env.DB_HOST,port:3306,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME}})),s.connection}static destroyConnection(){return o(this,void 0,void 0,(function*(){s.connection&&(yield s.connection.destroy(),s.connection=null)}))}}t.BaseDatabase=s,s.connection=null},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Authenticator=void 0;const s=i(n(20));class a{constructor(){this.getData=e=>s.verify(e,process.env.JWT_KEY)}generateToken(e){return s.sign({id:e.id},process.env.JWT_KEY,{expiresIn:a.EXPIRES_IN})}verifyToken(e){return{id:s.verify(e,process.env.JWT_KEY).id}}}t.Authenticator=a,a.EXPIRES_IN="30min"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IdGenerator=void 0;const o=n(17);t.IdGenerator=class{generate(){return o.v4()}}},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserDatabase=void 0;const r=n(0),i=n(5),s=n(19);class a extends r.BaseDatabase{createUser(e,t,n,r){return o(this,void 0,void 0,(function*(){yield this.getConnection().insert({id:e,name:t,email:n,password:r}).into(a.TABLE_NAME)}))}userInfo(e){return o(this,void 0,void 0,(function*(){const t=(yield this.getConnection().select("*").from(a.TABLE_NAME).where({email:e}))[0];return new s.User(t.id,t.name,t.email,t.password,t.type)}))}getUserById(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().select("*").from(a.TABLE_NAME).where({id:e}))[0]}))}deleteUser(e){return o(this,void 0,void 0,(function*(){yield this.getConnection().raw(`\n    DELETE FROM ${a.TABLE_NAME} WHERE id = "${e}"`)}))}getInfoById(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().raw(`\n    SELECT id, email FROM ${a.TABLE_NAME} WHERE id = "${e}"`))[0]}))}getFriends(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().raw(`\n      SELECT friend_id FROM ${i.RelationsDatabase.TABLE_NAME} WHERE user_id = "${e}"`))[0]}))}}t.UserDatabase=a,a.TABLE_NAME="LaBook_Users"},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RelationsDatabase=void 0;const r=n(0);class i extends r.BaseDatabase{addFriend(e,t){return o(this,void 0,void 0,(function*(){yield this.getConnection().raw(`\n    INSERT INTO ${i.TABLE_NAME} VALUES ("${e}", "${t}")\n    `)}))}removeFriend(e,t){return o(this,void 0,void 0,(function*(){yield this.getConnection().raw(`\n      DELETE FROM ${i.TABLE_NAME} WHERE user_id = "${e}" AND friend_id = "${t}"\n    `)}))}}t.RelationsDatabase=i,i.TABLE_NAME="Relations"},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PostDatabase=void 0;const r=n(0);class i extends r.BaseDatabase{createPosts(e,t,n,r,s,a){return o(this,void 0,void 0,(function*(){yield this.getConnection().insert({id:e,photo:t,description:n,creation_date:r,type:s,creator_user_id:a}).into(i.TABLE_NAME)}))}getPosts(){return o(this,void 0,void 0,(function*(){return yield this.getConnection().select("*").from(i.TABLE_NAME)}))}getPostById(e){return o(this,void 0,void 0,(function*(){return(yield this.getConnection().select("*").from(i.TABLE_NAME).where({id:e}))[0]}))}getPostByType(e){return o(this,void 0,void 0,(function*(){return yield this.getConnection().select("*").from(i.TABLE_NAME).where({type:e.type}).orderBy(e.orderBy,e.orderType)}))}}t.PostDatabase=i,i.TABLE_NAME="Posts"},function(e,t){e.exports=require("moment")},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.handler=void 0;const r=o(n(9)),i=n(10);t.handler=r.default(i.app)},function(e,t){e.exports=require("serverless-http")},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0;const r=o(n(1)),i=o(n(11)),s=n(12),a=n(21),u=o(n(23));if(n(24),i.default.config(),t.app=r.default(),t.app.use(u.default({origin:!0})),t.app.use(r.default.json()),t.app.use("/user",s.userRouter),t.app.use("/post",a.PostRouter),"serverless"!==process.env.NODE_env){const e=t.app.listen(process.env.PORT||3003,()=>{if(e){const t=e.address();console.log("Server is running in http://localhost:"+t.port)}else console.error("Failure upon starting server.")})}},function(e,t){e.exports=require("dotenv")},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.controller=t.userRouter=void 0;const r=o(n(1)),i=n(13);t.userRouter=r.default.Router(),t.controller=new i.UserController,t.userRouter.post("/signup",t.controller.signup),t.userRouter.post("/login",t.controller.login),t.userRouter.post("/add",t.controller.addFriend),t.userRouter.delete("/remove",t.controller.removeFriend),t.userRouter.get("/friends",t.controller.getFriends)},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserController=void 0;const r=n(14),i=n(16),s=n(0),a=n(4),u=n(2),c=n(5);t.UserController=class{signup(e,t){return o(this,void 0,void 0,(function*(){try{if(!e.body.password||e.body.password.length<6)throw new Error("Your passwords needs at least 6 characters!");const n={email:e.body.email,password:e.body.password,name:e.body.name};if(-1===e.body.email.indexOf("@"))throw new Error("Please, provide a valid email address");const o=new r.HashManager,s=yield o.hash(n.password),c=new i.UserBusiness;yield c.signup(n.name,n.email,s);const d=new a.UserDatabase,l=yield d.userInfo(e.body.email),f=new u.Authenticator,h=yield f.generateToken({id:l.getId()});t.status(200).send({message:`User ${n.name} created successfully`,token:h})}catch(e){t.status(400).send({message:e.message})}s.BaseDatabase.destroyConnection()}))}login(e,t){return o(this,void 0,void 0,(function*(){try{if(!e.body.email||-1===e.body.email.indexOf("@"))throw new Error("Invalid email");const n={email:e.body.email,password:e.body.password},o=new a.UserDatabase,i=yield o.userInfo(n.email),s=new r.HashManager;if(!(yield s.compare(n.password,i.getPassword())))throw new Error("Invalid password");const c=(new u.Authenticator).generateToken({id:i.getId()});t.status(200).send({token:c})}catch(e){t.status(400).send({message:e.message})}s.BaseDatabase.destroyConnection()}))}addFriend(e,t){return o(this,void 0,void 0,(function*(){try{const n=e.body.id;if(n){const o=e.headers.authorization,r=(new u.Authenticator).verifyToken(o),i=new a.UserDatabase,s=yield i.getUserById(r.id),d=new c.RelationsDatabase;yield d.addFriend(s.id,n),t.status(200).send({message:"You are now friends!"})}}catch(e){t.status(400).send({message:e.message})}yield s.BaseDatabase.destroyConnection()}))}removeFriend(e,t){return o(this,void 0,void 0,(function*(){try{const n=e.body.id;if(n){const o=e.headers.authorization,r=(new u.Authenticator).verifyToken(o),i=new a.UserDatabase,s=yield i.getUserById(r.id),d=new c.RelationsDatabase;yield d.removeFriend(s.id,n),t.status(200).send({message:"You're no longer friends"})}}catch(e){t.status(400).send({message:e.message})}yield s.BaseDatabase.destroyConnection()}))}getFriends(e,t){return o(this,void 0,void 0,(function*(){try{const n=e.headers.authorization,o=(new u.Authenticator).verifyToken(n),r=new a.UserDatabase,i=yield r.getFriends(o.id);t.status(200).send({friends:i})}catch(e){t.status(400).send({message:e.message})}s.BaseDatabase.destroyConnection()}))}}},function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},s=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.HashManager=void 0;const a=i(n(15));t.HashManager=class{hash(e){return s(this,void 0,void 0,(function*(){const t=Number(process.env.ROUNDS),n=yield a.genSalt(t);return yield a.hash(e,n)}))}compare(e,t){return s(this,void 0,void 0,(function*(){return yield a.compare(e,t)}))}}},function(e,t){e.exports=require("bcryptjs")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UserBusiness=void 0;const r=n(3),i=n(4);t.UserBusiness=class{signup(e,t,n){return o(this,void 0,void 0,(function*(){const o=(new r.IdGenerator).generate(),s=new i.UserDatabase;yield s.createUser(o,e,t,n)}))}}},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("knex")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.User=t.UserType=void 0,function(e){e.NORMAL="NORMAL",e.EVENTO="EVENTO"}(t.UserType||(t.UserType={}));t.User=class{constructor(e,t,n,o,r){this.id=e,this.name=t,this.email=n,this.password=o,this.type=r}getId(){return this.id}getEmail(){return this.email}getName(){return this.name}getPassword(){return this.password}getType(){return this.type}setId(e){this.id=e}setEmail(e){this.email=e}setName(e){this.name=e}}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PostRouter=void 0;const i=r(n(1)),s=n(2),a=n(6),u=r(n(7)),c=n(0),d=n(22);t.PostRouter=i.default.Router(),t.PostRouter.post("/create",d.create),t.PostRouter.get("/feed",(e,t)=>o(void 0,void 0,void 0,(function*(){try{(new s.Authenticator).getData(e.headers.authorization);const n=new a.PostDatabase,o=(yield n.getPosts()).map(e=>(e.creation_date=u.default(e.creation_date).format("DD/MM/YYYY"),e));t.status(200).send({feeds:o})}catch(e){t.status(400).send({message:e.message})}yield c.BaseDatabase.destroyConnection()}))),t.PostRouter.get("/",d.getPostByType)},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((o=o.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getPostByType=t.create=void 0;const i=n(0),s=n(2),a=n(3),u=n(6),c=r(n(7));t.create=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n=(new s.Authenticator).getData(e.headers.authorization);if(!e.body.photo||!e.body.description||!e.body.type)throw new Error("Invalid");const o=(new a.IdGenerator).generate(),r=c.default().format("YYYY-MM-DD"),i={photo:e.body.photo,description:e.body.description,type:e.body.type},d=new u.PostDatabase;yield d.createPosts(o,i.photo,i.description,r,i.type,n.id),t.status(200).send({message:"Post Criado"})}catch(e){t.status(400).send({mesage:e.message})}i.BaseDatabase.destroyConnection()})),t.getPostByType=(e,t)=>o(void 0,void 0,void 0,(function*(){try{const n={type:e.query.type,orderBy:e.query.orderBy||"creation_date",orderType:e.query.orderType||"ASC"},o=yield(new u.PostDatabase).getPostByType(n);t.status(200).send({posts:o})}catch(e){e.message}i.BaseDatabase.destroyConnection()}))},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("mysql")}]);